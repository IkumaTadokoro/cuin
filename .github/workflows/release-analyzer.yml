name: Release cuin-analyzer

on:
   push:
      tags:
         - "v*"

permissions:
   contents: write
   id-token: write

concurrency:
   group: ${{ github.workflow }}-${{ github.ref }}
   cancel-in-progress: true

jobs:
   build:
      name: Build ${{ matrix.settings.target }}
      runs-on: ${{ matrix.settings.host }}
      strategy:
         fail-fast: false
         matrix:
            settings:
               - host: macos-latest
                 target: x86_64-apple-darwin
               - host: macos-latest
                 target: aarch64-apple-darwin
               - host: windows-latest
                 target: x86_64-pc-windows-msvc
               - host: ubuntu-latest
                 target: x86_64-unknown-linux-gnu
               - host: ubuntu-latest
                 target: aarch64-unknown-linux-gnu

      steps:
         - uses: actions/checkout@v5.0.0

         - uses: pnpm/action-setup@v4

         - uses: actions/setup-node@v4
           with:
              node-version: 22
              cache: pnpm

         - name: Setup Rust
           uses: dtolnay/rust-toolchain@stable
           with:
              toolchain: "1.88.0"
              targets: ${{ matrix.settings.target }}

         - name: Rust Cache
           uses: Swatinem/rust-cache@v2
           with:
              workspaces: packages/analyzer
              key: ${{ matrix.settings.target }}

         - run: pnpm install --frozen-lockfile

         - name: Build
           working-directory: packages/analyzer
           run: |
              if [[ "${{ matrix.settings.target }}" == "aarch64-unknown-linux-gnu" ]]; then
                pnpm build --target ${{ matrix.settings.target }} --use-napi-cross
              else
                pnpm build --target ${{ matrix.settings.target }}
              fi
           shell: bash

         - name: Upload artifact
           uses: actions/upload-artifact@v4
           with:
              name: bindings-${{ matrix.settings.target }}
              path: packages/analyzer/bindings/*.node
              if-no-files-found: error

         - name: Upload JS bindings
           if: matrix.settings.target == 'x86_64-apple-darwin'
           uses: actions/upload-artifact@v4
           with:
              name: js-bindings
              path: |
                 packages/analyzer/bindings/index.js
                 packages/analyzer/bindings/index.d.ts

   publish:
      name: Publish
      runs-on: ubuntu-latest
      needs: build
      steps:
         - uses: actions/checkout@v5.0.0

         - uses: pnpm/action-setup@v4

         - name: Setup Node.js
           uses: actions/setup-node@v4
           with:
              node-version: 22
              cache: pnpm
              registry-url: "https://registry.npmjs.org/"

         - run: pnpm install --frozen-lockfile

         - name: Download all artifacts
           uses: actions/download-artifact@v4
           with:
              path: packages/analyzer/artifacts

         - name: Download JS bindings
           uses: actions/download-artifact@v4
           with:
              name: js-bindings
              path: packages/analyzer/bindings

         - name: Create npm dirs & move artifacts
           working-directory: packages/analyzer
           run: |
              pnpm napi create-npm-dirs
              pnpm napi artifacts

         - name: Publish
           working-directory: packages/analyzer
           run: pnpm napi pre-publish --tag-style npm --gh-release=false
           env:
              NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

         - name: Publish main package
           working-directory: packages/analyzer
           run: pnpm publish --no-git-checks --access public
           env:
              NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
